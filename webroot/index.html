<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Canvas Test</title>
</head>
<body>
  <section>
    <div>
      <canvas id="canvas" width="400" height="300">
        This text is displayed if your browser does not support HTML5 Canvas.
      </canvas>
    </div>
   <script type="text/javascript">

      // var colorList = [
      //   'blue',
      //   'green',
      //   'yellow',
      //   'black',
      //   'orange',
      //   'pink',
      //   'red'
      // ];
      // var randomNumber = Math.floor(Math.random()*colorList.length);
      // $('#nameuser').val(colorList[randomNumber]);

      var canvas;
      var ctx;
      var dx = 5;
      var dy = 5;
      var tankWidth = 20;
      var tankHeight = 20;
      var x = 0;
      var y = 0;
      var users = [];
      var WIDTH = 400;
      var HEIGHT = 300;

      var keyUpPressed = false;
      var keyDownPressed = false;
      var keyLeftPressed = false;
      var keyRightPressed = false;

      var websocket = new WebSocket("ws://localhost:8080/entry");

     websocket.onmessage = function(str) {
        console.log(str.data);
        data = str.data.split("\n");
        // x = 10;
        // y = 10;
        users = [];
        for (k in data) {
          parseLine(data[k]);
        }
      };

      function parseLine(line){
        if (line != '')
        {
          data = line.split(';');
          switch (data[0])
          {
            case 'T':
              users[data[1]] = {
                posX: parseInt(data[3]), 
                posY: parseInt(data[4]), 
                color: data[2],
                direction: parseInt(data[5])};
              break;
          }
        }
      }
      
      function rect(x,y,w,h,stroke) {
        ctx.beginPath();
        ctx.rect(x,y,w,h);
        ctx.closePath();
        ctx.fill();
        if(stroke)
        {
          ctx.stroke();
        }
      }

      function clear() {
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
      }

      function init() {
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        return setInterval(draw, 30);
      }

      function websocketAction(action){
        websocket.send(JSON.stringify({
            // author: $('#nameuser').val(),
            body: action
          }));
      }

      function doKeyDown(evt) {
        switch (evt.keyCode) {
          case 32:  /* Space was pressed */
            websocketAction("fire");
          break;
          case 38:
            if (!keyUpPressed) {
              keyUpPressed = true;
              websocketAction("up");
            }
          break;
          case 40:  /* Down arrow */
            if (!keyDownPressed) {
              keyDownPressed = true;
              websocketAction("down");
            }
          break;
          case 37:  /* Left arrow was pressed */
            if (!keyLeftPressed) {
              keyLeftPressed = true;
              websocketAction("left");
            }
          break;
          case 39:  /* Right arrow was pressed */
            if (!keyRightPressed) {
              keyRightPressed = true;
              websocketAction("right");
            }
          break;
        }
      }

      function doKeyUp(evt){
        switch (evt.keyCode) {
          case 38:
            if (keyUpPressed) {
              websocketAction("up2");
              keyUpPressed = false;
            }
          break;
          case 40:  /* Down arrow was pressed */
            if (keyDownPressed) {
              websocketAction("down2");
              keyDownPressed = false;
            }
          break;
          case 37:  /* Left arrow was pressed */
            if (keyLeftPressed) {
              websocketAction("left2");
              keyLeftPressed = false;
            }
          break;
          case 39:  /* Right arrow was pressed */
            if (keyRightPressed) {
              websocketAction("right2");
              keyRightPressed = false;
            }
          break;
        }
      }

      function draw() {
        clear();
        ctx.fillStyle = "white";
        ctx.strokeStyle = "black";
        rect(0,0,WIDTH,HEIGHT, true);
        for (k in users) {
          ctx.fillStyle = users[k].color;
          rect(users[k].posX, users[k].posY, tankWidth, tankHeight, false);
        }
      }

      init();
      window.addEventListener('keydown',doKeyDown, true);
      window.addEventListener('keyup', doKeyUp, true);
    </script>
  </section>
</body>
</html>
