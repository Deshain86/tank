<!doctype html>
<html>
<head>
 	<meta charset="UTF-8" />
 	<title>Canvas Test</title>
</head>
<body>
 	<section>
   		<div>
    		<canvas id="canvas" width="800" height="800">
			This text is displayed if your browser does not support HTML5 Canvas.
    		</canvas>
		</div>
		
    	<script type="text/javascript">
		var canvas;
		var ctx;
		var dx = 5;
		var dy = 5;
		var tankWidth = 40;
		var tankHeight = 40;
		var x = 0;
		var y = 0;
		var users = [];
		var WIDTH = 800;
		var HEIGHT = 800;
	
		var TO_RADIANS = Math.PI / 180;
		
		var tanksPath = "./resources/Tanks/";
		var tanksList = ["tankBlack.png", "tankBlue.png", "tankGreen.png", "tankRed.png"];
		var barrelList = ["barrelBlack.png", "barrelBlue.png", "barrelGreen.png", "barrelRed.png"];
		
		var bulletPath = "./resources/Bullets/";
		var bulletList = [""];
		
		var tanksImages = [];
		var barrelImages = [];
		var bulletImages = [];
		
		var lastPressed = "u";
      	var websocket = new WebSocket("ws://localhost:8080/entry");

      websocket.onmessage = function(str) {
        console.log(str.data);
        data = str.data.split("\n");
        // x = 10;
        // y = 10;
        users = [];
        for (k in data) {
          parseLine(data[k]);
        }
      };

      function parseLine(line){
        if (line != '')
        {
          data = line.split(';');
          switch (data[0])
          {
            case 'T':
              users[data[1]] = {
                posX: parseInt(data[3]), 
                posY: parseInt(data[4]), 
                color: data[2],
                direction: parseInt(data[5])};
              break;
          }
        }
      }
     
		function rect(x, y, w, h, stroke) {
			ctx.beginPath();
			ctx.rect(x, y, w, h);
			ctx.closePath();
			ctx.fill();
			
			if (stroke)
			{
				ctx.stroke();
			}
		}
	
		function tank(x, y, w, h, c, d) {	// x, y - coords; w, h - dimensions; c - color; d - direction
			var index = 0;
			var angle = 0;
			
			switch (c) {
				case "k":
					index = 0;
					break;
				case "b":
					index = 1;
					break;
				case "g":
					index = 2;
					break;
				case "r":
					index = 3;
					break;			
			}
			
			switch (d) {
				case "u":
					angle = 0;
					break;
				case "d":
					angle = 180;
					break;
				case "l":
					angle = -90;
					break;
				case "r":
					angle = 90;
					break;
			}
			
			// save the current co-ordinate system 
			// before we screw with it
			ctx.save(); 
		 
			// move to the middle of where we want to draw our image
			ctx.translate(x + w/2, y + h/2);
		 
			// rotate around that point, converting our 
			// angle from degrees to radians 
			ctx.rotate(angle * TO_RADIANS);
	 
			// draw it up and to the left by half the width
			// and height of the image 
			ctx.drawImage(tanksImages[index], -(tanksImages[index].width/2), -(tanksImages[index].height/2));
			ctx.drawImage(barrelImages[index], -(barrelImages[index].width/2), -(barrelImages[index].height/2) -20);
			//ctx.drawImage(tanksImages[index], 0, 0, 75, 70, x, y, w, h)
			
			// and restore the co-ords to how they were when we began
			ctx.restore(); 
		}

	    function clear() {
	    	ctx.clearRect(0, 0, WIDTH, HEIGHT);
	    }

		function init() {
			canvas = document.getElementById("canvas");
			ctx = canvas.getContext("2d");
			
			for (var i = 0; i < tanksList.length; i++) {
				var tnk = new Image();
				tnk.src = tanksPath + tanksList[i];
				tanksImages.push(tnk);
				
				var brl = new Image();
				brl.src = tanksPath + barrelList[i];
				barrelImages.push(brl);
			}
			
			return setInterval(draw, 30);
		}

		function websocketAction(action){
			websocket.send(JSON.stringify({
				body: action
			}));
		}

		function doKeyDown(evt){
			switch (evt.keyCode) {
				case 32:  /* Space was pressed */
					websocketAction("fire");
					break;
				case 38:  /* Up arrow was pressed */
					lastPressed = "u"
					websocketAction("up");
					break;
				case 40:  /* Down arrow was pressed */
					lastPressed = "d"
					websocketAction("down");
					break;
				case 37:  /* Left arrow was pressed */
					lastPressed = "l"
					websocketAction("left");
					break;
				case 39:  /* Right arrow was pressed */
					lastPressed = "r"
					websocketAction("right");
					break;
			}
		}

		function draw() {
			clear();
			
			ctx.fillStyle = "white";
			ctx.strokeStyle = "black";
			rect(0, 0, WIDTH, HEIGHT, true);
			
			for (k in users) {
				tank(users[k].posX, users[k].posY, tankWidth, tankHeight, users[k].color, lastPressed);
			}
		}

		init();
		window.addEventListener('keydown',doKeyDown,true);
    	</script>
  	</section>
</body>
</html>
