<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Canvas Test</title>
</head>
<body>
  <section>
      <div>
        <canvas id="canvas" width="800" height="800">
      This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
    </div>
    
      <script type="text/javascript">
    var canvas;
    var ctx;
    var dx = 5;
    var dy = 5;
    var tankWidth = 37;
    var tankHeight = 35;
    var bulletWidth = 7;
    var bulletHeight = 5;
    var x = 0;
    var y = 0;
    var users = [];
    var bullets = [];
    var WIDTH = 800;
    var HEIGHT = 800;

    var keySpacePressed = false;
    var keyUpPressed = false;
    var keyDownPressed = false;
    var keyLeftPressed = false;
    var keyRightPressed = false;

    var TO_RADIANS = Math.PI / 180;
    
    var tanksPath = "./resources/Tanks/";
    var tanksList = ["tankBlack.png", "tankBlue.png", "tankGreen.png", "tankRed.png"];
    var barrelList = ["barrelBlack.png", "barrelBlue.png", "barrelGreen.png", "barrelRed.png"];
    
    var bulletPath = "./resources/Bullets/";
    var bulletList = ["bulletSilverSilver.png", "bulletBlueSilver.png", "bulletGreenSilver.png", "bulletRedSilver.png"];
    
    var tanksImages = [];
    var barrelImages = [];
    var bulletImages = [];
    var pressed = [];
    
    var lastPressed = "u";
        var websocket = new WebSocket("ws://localhost:8080/entry");

     websocket.onmessage = function(str) {
        // console.log(str.data);
        datalist = str.data.split("\n");
        // x = 10;
        // y = 10;
        users = [];
        bullets = [];
        for (k in datalist) {
          parseLine(datalist[k]);
        }
      };

      function parseLine(line){
        if (line != '')
        {
          data = line.split(';');
          switch (data[0])
          {
            case 'T':
              users[data[1]] = {
                posX: parseInt(data[3]), 
                posY: parseInt(data[4]), 
                color: data[2],
                direction: parseInt(data[5])};
              break;
            case 'B':
              bullets.push({
                posX: parseInt(data[1]), 
                posY: parseInt(data[2]), 
                direction: parseInt(data[3])});
              break;
          }
        }
      }

    function rect(x, y, w, h, stroke) {
      ctx.beginPath();
      ctx.rect(x, y, w, h);
      ctx.closePath();
      ctx.fill();
      
      if (stroke)
      {
        ctx.stroke();
      }
    }
  
    function drawObject(t, x, y, w, h, c, d) {  // t - type; x, y - coords; w, h - dimensions; c - color; d - direction
      var index = 0;
      var angle = d;
      
      switch (c) {
        case "k":
          index = 0;
          break;
        case "b":
          index = 1;
          break;
        case "g":
          index = 2;
          break;
        case "r":
          index = 3;
          break;      
      }
      
      // save the current co-ordinate system 
      // before we screw with it
      ctx.save(); 
	
	  // move to the middle of where we want to draw our image
      ctx.translate(x + w/2, y + h/2);
     
      // rotate around that point, converting our 
      // angle from degrees to radians 
      ctx.rotate(angle * TO_RADIANS);
   
      // draw it up and to the left by half the width
      // and height of the image 
      switch (t) {
        case "tank":
          ctx.drawImage(tanksImages[index], 0, 0, 75, 70, -w/2, -h/2, w, h);
		  ctx.drawImage(barrelImages[index], 0, 0, 16, 50, -8/2, -25/2 - 10, 8, 25);
          break;
        case "bullet":
          ctx.drawImage(bulletImages[index], -(bulletImages[index].width/2), -(bulletImages[index].height/2));
          break;
      }
      
      // and restore the co-ords to how they were when we began
      ctx.restore(); 
    }

      function clear() {
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
      }

    function init() {
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext("2d");
      
      for (var i = 0; i < tanksList.length; i++) {
        var tnk = new Image();
        tnk.src = tanksPath + tanksList[i];
        tanksImages.push(tnk);
        
        var brl = new Image();
        brl.src = tanksPath + barrelList[i];
        barrelImages.push(brl);
        
        var bul = new Image();
        bul.src = bulletPath + bulletList[i];
        bulletImages.push(bul);
      }
      
      return setInterval(draw, 30);
    }

    function websocketAction(action){
      websocket.send(JSON.stringify({
        body: action
      }));
    }

    function doKeyDown(evt){
      console.log(evt.keyCode);
      switch (evt.keyCode) {
        case 32:
          if (!keySpacePressed) {
            pressed.push("fire");
            keySpacePressed = true;
            websocketAction("fire");
          }
          break;
        case 38:
          if (!keyUpPressed) {
            pressed.push("up");
            keyUpPressed = true;
            websocketAction("up");
          }
        break;
        case 40:  /* Down arrow */
          if (!keyDownPressed) {
            pressed.push("down");
            keyDownPressed = true;
            websocketAction("down");
          }
        break;
        case 37:  /* Left arrow was pressed */
          if (!keyLeftPressed) {
            pressed.push("left");
            keyLeftPressed = true;
            websocketAction("left");
          }
        break;
        case 39:  /* Right arrow was pressed */
          if (!keyRightPressed) {
            pressed.push("right");
            keyRightPressed = true;
            websocketAction("right");
          }
        break;
      }
    }

    function doKeyUp(evt){
    	var direction;
      switch (evt.keyCode) {
        case 32:
          if (keySpacePressed) {
            direction = "fire2";
            removePressed('fire');
            keySpacePressed = false;
          }
        break;
        case 38:
          if (keyUpPressed) {
            direction = "up2";
            removePressed('up');
            keyUpPressed = false;
          }
        break;
        case 40:  /* Down arrow was pressed */
          if (keyDownPressed) {
            direction = "down2";
            removePressed('down');
            keyDownPressed = false;
          }
        break;
        case 37:  /* Left arrow was pressed */
          if (keyLeftPressed) {
            direction = "left2";
            removePressed('left');
            keyLeftPressed = false;
          }
        break;
        case 39:  /* Right arrow was pressed */
          if (keyRightPressed) {
            direction = "right2";
            removePressed('right');
            keyRightPressed = false;
          }
        break;
      }
      if(pressed.length == 0 && direction)
      {
      	websocketAction(direction);
      }
      else if (pressed.length > 0 && direction)
      {
        websocketAction(pressed[pressed.length - 1]);
      }
    }

    function removePressed(direction) {
      var selected = -1;
      for (var i = 0; i < pressed.length; i++)
      {
        if(pressed[i] == direction)
        {
          selected = i;
          break;
        }
      }
      pressed.splice(selected, 1);
    }

    function draw() {
      clear();
      
      ctx.fillStyle = "white";
      ctx.strokeStyle = "black";
      rect(0, 0, WIDTH, HEIGHT, true);
      
      for (k in bullets){
        drawObject("bullet", bullets[k].posX, bullets[k].posY, bulletWidth, bulletHeight, "b", bullets[k].direction);
      }
      for (k in users) {
        drawObject("tank", users[k].posX, users[k].posY, tankWidth, tankHeight, users[k].color, users[k].direction);
      }
      
      //for (k in bullets) {
      //  drawObject("bullet", bullets[k].posX, bullets[k].posY, bulletWidth, bulletHeight, bullets[k].color, bullets[k].direction);
      //}
    }

      init();
      window.addEventListener('keydown',doKeyDown, true);
      window.addEventListener('keyup', doKeyUp, true);
      </script>
    </section>
</body>
</html>